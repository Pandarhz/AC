<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Souvenirs des Écrins</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome (pour les personnages) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #000000;
            --accent-color: #ff4500;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
            background-color: #1a1a1a;
        }

        /* --- 1. INTRO ANIMATION (Marcheurs) --- */
        #intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeOutIntro 1s ease-out 4s forwards; /* Disparait après 4s */
            pointer-events: none;
        }

        .walkers-container {
            position: absolute;
            bottom: 40%;
            left: -20%; /* Départ à gauche hors écran */
            display: flex;
            gap: 20px;
            animation: walkAcross 4s linear forwards;
        }

        .walker {
            font-size: 3rem;
            color: white;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        /* Animation de sautillement pour simuler la marche */
        .walker i {
            animation: bounce 0.5s infinite alternate ease-in-out;
        }
        .walker:nth-child(2) i { animation-delay: 0.1s; }
        .walker:nth-child(3) i { animation-delay: 0.2s; }

        /* --- 2. DIAPORAMA (Overlay) --- */
        #slideshow-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 3000;
            display: none; /* Caché par défaut */
            align-items: center;
            justify-content: center;
        }

        #slideshow-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            animation: popIn 0.3s ease-out; /* Effet d'apparition sec */
        }

        /* --- 3. CARTE ET INTERFACE --- */
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            z-index: 1;
        }

        .ui-container {
            position: absolute;
            bottom: 50px;
            width: 100%;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            /* Apparait après l'intro et le zoom (env 8s) */
            animation: fadeInUI 1s ease-out 8s forwards; 
            pointer-events: none; /* Pour cliquer au travers si besoin */
        }

        /* Bouton Noir */
        .start-btn {
            background-color: #000000;
            color: white;
            padding: 20px 40px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 800;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 2px solid white;
            pointer-events: auto;
            cursor: pointer;
            display: inline-block;
            transition: transform 0.1s;
        }
        
        .start-btn:active {
            transform: scale(0.95);
        }
        /* Disabled state while images preload */
        .start-btn.disabled {
            opacity: 0.6;
            cursor: default;
            pointer-events: none;
            filter: grayscale(30%);
        }
        .start-btn .progress {
            display: block;
            font-size: 0.8rem;
            margin-top: 6px;
            opacity: 0.9;
        }

        /* --- KEYFRAMES --- */
        @keyframes walkAcross {
            0% { left: -20%; }
            100% { left: 120%; } /* Sort à droite */
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }

        @keyframes fadeOutIntro {
            to { opacity: 0; visibility: hidden; }
        }

        @keyframes fadeInUI {
            to { opacity: 1; }
        }

        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

    </style>
</head>
<body>

    <!-- 1. Intro Animation -->
    <div id="intro-screen">
        <div class="walkers-container">
            <!-- 3 personnages -->
            <div class="walker"><i class="fa-solid fa-person-hiking"></i></div>
            <div class="walker"><i class="fa-solid fa-person-skiing"></i></div>
            <div class="walker"><i class="fa-solid fa-person-snowboarding"></i></div>
        </div>
    </div>

    <!-- 2. Diaporama Rapide -->
    <div id="slideshow-overlay">
        <img id="slideshow-img" src="" alt="Souvenir">
    </div>

    <!-- 3. Interface Bouton -->
    <div class="ui-container" id="ui-layer">
        <button id="start-btn" class="start-btn disabled" onclick="launchSlideshow()" aria-disabled="true">
            <span class="label">Lancer l'exploration</span>
            <span class="progress" id="start-progress">Chargement…</span>
        </button>
    </div>

    <!-- 4. Carte -->
    <div id="map"></div>

    <!-- Audio background -->
    <audio id="bg-audio" src="./Jump (Instrumental) - Van Halen.m4a" preload="auto" loop></audio>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIGURATION ---
        // Liste de tes photos (assure-toi qu'elles sont dans le dossier avec index.html)
        // Renomme tes photos 1.jpg, 2.jpg... pour faciliter la vie !
        // J'ai mis des placeholders Unsplash pour l'exemple, REMPLACE LES NOMS ci-dessous par tes fichiers.
        const myPhotos = [
            '1.jpg', '2.jpeg', '3.jpeg', '4.jpeg', '5.jpeg',
            '6.png', '7.png', '8.png', '9.png', '10.png',
            '11.JPG', '12.JPG', '13.JPG', '14.JPG', '15.JPG',
            '16.JPG', '17.JPG', '18.jpeg', '19.jpg', '20.jpg',
            '21.JPG', '22.JPG', '23.JPG', '24.JPG', '25.jpeg',
            '26.JPG', '27.JPG', '28.JPG', '29.JPG', '30.JPG',
            '31.JPG', '32.jpeg', '33.jpg', '34.jpeg', '35.jpeg',
            '36.jpeg', '37.jpg', '38.jpeg', '39.jpeg', '40.jpeg',
            '41.JPG', '42.jpeg', '43.PNG', '44.jpg', '45.jpg',
            '46.jpeg', '47.jpeg', '48.jpeg', '49.JPG', '50.JPG',
            '51.jpeg', '52.jpeg', '53.jpeg', '54.jpg', '55.JPG',
            '56.jpeg', '57.jpeg', '58.jpeg', '59.jpeg', '60.jpeg',
            '61.jpeg', '62.jpeg', '63.jpeg', '64.jpeg', '65.jpeg',
            '66.jpeg', '67.jpeg', '68.JPG', '69.jpeg', '70.jpeg',
            '71.jpeg', '72.jpeg', '73.jpeg', '74.png', '75.jpeg',
            '76.jpg', '77.jpeg', '78.jpeg', '79.jpeg', '80.jpeg',
            '81.jpeg', '82.jpeg', '83.jpeg', '84.jpeg', '85.jpeg',
            '86.jpeg', '87.jpeg', '88.png', '89.JPG'
        ];

        // Si tu n'as pas encore mis tes photos locales, ce code utilise des images démo :
        const demoPhotos = [
           'https://images.unsplash.com/photo-1519681393784-d120267933ba',
           'https://images.unsplash.com/photo-1454496522488-7a8e488e8606',
           'https://images.unsplash.com/photo-1486870591958-9b9d0d1dda99',
           'https://images.unsplash.com/photo-1551632811-561732d1e306',
           'https://images.unsplash.com/photo-1605542058732-22f35492d192'
        ];
        
        // IMPORTANT : Change cette variable sur 'true' quand tu as mis tes vraies photos
        const useLocalPhotos = true; 

        const photosToUse = useLocalPhotos ? myPhotos : demoPhotos;

        // Coordonnées Cibles (Lac Besson)
        const targetCoords = [44.9530, 6.0974]; 

        // 1. Initialisation Carte (Vue Espace - Zoom Lointain)
        const map = L.map('map', {
            center: [46.2276, 2.2137], // Centre de la France
            zoom: 1, // Vue de très haut
            zoomControl: false,
            attributionControl: false
        });

        // Fond de carte Topographique
        L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 25,
            attribution: 'OpenTopoMap'
        }).addTo(map);

        // 2. Gestion de l'arrivée (Zoom depuis l'espace)
        // L'intro dure 4s, on attend la fin pour lancer le zoom
        setTimeout(() => {
            map.flyTo(targetCoords, 13, {
                animate: true,
                duration: 9 // Le vol dure 4 secondes
            });
            
            // Une fois arrivé, on met un marqueur
            setTimeout(() => {
                L.marker(targetCoords).addTo(map)
                .bindPopup("<b>Notre Spot</b><br>Lac de la Muzelle").openPopup();
            }, 4500);

        }, 4000);

        // 3. Audio autoplay handling + preloading function
        const bgAudio = document.getElementById('bg-audio');
        let audioAutoplayBlocked = false;

        // Try to play audio on load; if blocked by browser, wait for user gesture.
        // Also start preloading photos in background and update the start button progress.
        let photosReady = false;
        let preloadLoaded = 0;
        let preloadTotal = 0;

        document.addEventListener('DOMContentLoaded', () => {
            // attempt audio autoplay
            if (bgAudio) {
                bgAudio.play().catch((err) => {
                    audioAutoplayBlocked = true;
                    console.log('Autoplay blocked, will play on user interaction.');
                });
            }

            // start preloading images silently in background
            const startBtn = document.getElementById('start-btn');
            const progressEl = document.getElementById('start-progress');
            const urls = photosToUse.map(p => './pictures/' + p);
            preloadTotal = urls.length;
            preloadImagesWithProgress(urls, 12000, (loaded, total) => {
                preloadLoaded = loaded;
                if (progressEl) progressEl.textContent = `Chargement ${loaded}/${total}`;
            }).then(() => {
                photosReady = true;
                if (progressEl) progressEl.textContent = 'Prêt — Lancer';
                if (startBtn) {
                    startBtn.classList.remove('disabled');
                    startBtn.removeAttribute('aria-disabled');
                    startBtn.style.pointerEvents = 'auto';
                }
            }).catch(() => {
                // On error or timeout, still enable the button so user can proceed
                photosReady = true;
                if (progressEl) progressEl.textContent = 'Prêt — Lancer';
                if (startBtn) {
                    startBtn.classList.remove('disabled');
                    startBtn.removeAttribute('aria-disabled');
                    startBtn.style.pointerEvents = 'auto';
                }
            });
        });

        // Preload images with progress callback. Resolves when all finished or when timeout reached.
        function preloadImagesWithProgress(urls, timeout = 5000, onProgress) {
            return new Promise((resolve) => {
                if (!Array.isArray(urls) || urls.length === 0) return resolve();
                let loaded = 0;
                const total = urls.length;
                let settled = false;

                const maybeResolve = () => {
                    if (settled) return;
                    settled = true;
                    if (onProgress) onProgress(total, total);
                    resolve();
                };

                urls.forEach(src => {
                    const img = new Image();
                    img.onload = () => {
                        loaded++;
                        if (onProgress) onProgress(loaded, total);
                        if (loaded >= total) maybeResolve();
                    };
                    img.onerror = () => {
                        // still count errors as "loaded" to avoid stalling
                        loaded++;
                        if (onProgress) onProgress(loaded, total);
                        if (loaded >= total) maybeResolve();
                    };
                    // start loading
                    img.src = src;
                });

                // Fallback timeout so we don't wait forever
                setTimeout(() => {
                    maybeResolve();
                }, timeout);
            });
        }

        // 4. Fonction Diaporama Rapide (avec préchargement)
        async function launchSlideshow() {
            const ui = document.getElementById('ui-layer');
            const overlay = document.getElementById('slideshow-overlay');
            const imgElement = document.getElementById('slideshow-img');
            // If photos are not ready yet, do nothing (button should be disabled)
            if (!photosReady) return;

            // Cacher le bouton
            ui.style.opacity = '0';

            // If audio couldn't autoplay, try to play now (user gesture)
            if (audioAutoplayBlocked && bgAudio) {
                bgAudio.play().catch(() => {/* ignore */});
            }

            // Show overlay immediately
            overlay.style.display = 'flex';

            // Start slideshow (images should be cached from preload)
            let index = 0;
            function showNextImage() {
                if (index >= photosToUse.length) {
                    endSlideshow();
                    return;
                }
                imgElement.src = './pictures/' + photosToUse[index];
                imgElement.style.animation = 'none';
                imgElement.offsetHeight; /* trigger reflow */
                imgElement.style.animation = 'popIn 0.3s ease-out';
                index++;
                setTimeout(showNextImage, 800);
            }
            showNextImage();
        }

        function endSlideshow() {
            const overlay = document.getElementById('slideshow-overlay');
            overlay.style.display = 'none';
            
            // Réactiver les contrôles de zoom pour l'utilisateur
            L.control.zoom({ position: 'bottomright' }).addTo(map);
        }

    </script>
</body>
</html>
